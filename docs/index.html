<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Posts Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root {
            --primary: #0088cc; --primary-dark: #006699; --secondary: #f8f9fa;
            --text: #202124; --text-light: #5f6368; --border: #dadce0;
            --card-bg: #ffffff; --success: #34a853; --warning: #fbbc05; --danger: #ea4335;
        }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .app-container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); min-height: 90vh; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 1.8rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .header p { opacity: 0.9; font-size: 0.95rem; }
        .stats-bar { display: flex; justify-content: space-around; padding: 15px; background: var(--secondary); border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: var(--text-light); margin-top: 2px; }
        .controls { padding: 20px; background: white; border-bottom: 1px solid var(--border); }
        .filter-row { display: flex; gap: 12px; margin-bottom: 15px; flex-wrap: wrap; }
        select, button { padding: 14px 20px; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; flex: 1; min-width: 150px; }
        select { background: white; cursor: pointer; }
        select:focus { border-color: var(--primary); outline: none; }
        button { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; cursor: pointer; font-weight: 600; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .posts-container { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .post-card { background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .post-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .post-id { background: var(--secondary); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; color: var(--text-light); font-family: monospace; }
        .post-category { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .category-general { background: #e3f2fd; color: #1565c0; }
        .category-news { background: #f3e5f5; color: #7b1fa2; }
        .category-media { background: #e8f5e9; color: #2e7d32; }
        .category-important { background: #ffebee; color: #c62828; }
        .post-content { color: var(--text); line-height: 1.6; margin-bottom: 15px; max-height: 150px; overflow: hidden; position: relative; }
        .post-content.expanded { max-height: none; }
        .read-more { background: linear-gradient(to top, white, transparent); position: absolute; bottom: 0; left: 0; right: 0; height: 40px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; }
        .read-more-btn { background: var(--primary); color: white; border: none; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; }
        .post-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .post-media { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: var(--secondary); border-radius: 12px; font-size: 0.85rem; color: var(--text-light); }
        .post-timestamp { font-size: 0.85rem; color: var(--text-light); }
        .no-posts { text-align: center; padding: 50px 20px; color: var(--text-light); }
        .pagination { display: flex; justify-content: center; gap: 10px; padding: 20px; background: var(--secondary); border-top: 1px solid var(--border); }
        .page-btn { padding: 10px 20px; border: 1px solid var(--border); background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .page-btn:hover:not(:disabled) { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .api-status { position: fixed; bottom: 20px; right: 20px; background: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); }
        .status-dot.connected { background: var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @media (max-width: 600px) { body { padding: 10px; } .app-container { border-radius: 15px; } .header { padding: 20px 15px; } .header h1 { font-size: 1.5rem; } .controls { padding: 15px; } .filter-row { flex-direction: column; } select, button { width: 100%; } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1><span>üì±</span>Telegram Posts Viewer</h1>
            <p>Mini App for viewing saved channel posts</p>
        </div>
        <div class="stats-bar">
            <div class="stat-item"><div class="stat-value" id="totalPosts">0</div><div class="stat-label">Total Posts</div></div>
            <div class="stat-item"><div class="stat-value" id="currentCategory">All</div><div class="stat-label">Current Filter</div></div>
            <div class="stat-item"><div class="stat-value" id="displayedPosts">0</div><div class="stat-label">Displayed</div></div>
        </div>
        <div class="controls">
            <div class="filter-row">
                <select id="categoryFilter"><option value="">All Categories</option></select>
                <button id="loadPostsBtn"><span class="btn-text">üì• Load Posts</span><span class="spinner" style="display:none;"></span></button>
            </div>
            <div class="filter-row">
                <select id="mediaTypeFilter">
                    <option value="">All Media Types</option>
                    <option value="text">Text</option><option value="photo">Photo</option><option value="video">Video</option>
                    <option value="document">Document</option><option value="audio">Audio</option>
                </select>
                <select id="sortBy"><option value="newest">Newest First</option><option value="oldest">Oldest First</option></select>
            </div>
        </div>
        <div class="posts-container" id="postsContainer">
            <div class="no-posts" id="noPostsMessage">
                <div style="font-size:3rem;margin-bottom:10px;">üì≠</div><h3>No posts loaded</h3><p>Select filters and click "Load Posts" to begin</p>
            </div>
        </div>
        <div class="pagination" id="pagination" style="display:none;">
            <button class="page-btn" id="prevPageBtn" disabled>‚Üê Previous</button>
            <div style="padding:10px 20px;" id="pageInfo">Page 1</div>
            <button class="page-btn" id="nextPageBtn">Next ‚Üí</button>
        </div>
    </div>
    <div class="api-status" id="apiStatus"><span class="status-dot"></span><span class="status-text">Connecting to API...</span></div>
    <script>
        const API_BASE_URL = 'https://asked-campaigns-medicare-piece.trycloudflare.com';
        let currentCategory = '', currentMediaType = '', currentSort = 'newest', currentPage = 1, postsPerPage = 10, totalPosts = 0, allPosts = [];
        const postsContainer = document.getElementById('postsContainer'), noPostsMessage = document.getElementById('noPostsMessage'),
              categoryFilter = document.getElementById('categoryFilter'), mediaTypeFilter = document.getElementById('mediaTypeFilter'),
              sortBy = document.getElementById('sortBy'), loadPostsBtn = document.getElementById('loadPostsBtn'),
              totalPostsElement = document.getElementById('totalPosts'), currentCategoryElement = document.getElementById('currentCategory'),
              displayedPostsElement = document.getElementById('displayedPosts'), apiStatus = document.getElementById('apiStatus'),
              statusDot = apiStatus.querySelector('.status-dot'), statusText = apiStatus.querySelector('.status-text'),
              pagination = document.getElementById('pagination'), prevPageBtn = document.getElementById('prevPageBtn'),
              nextPageBtn = document.getElementById('nextPageBtn'), pageInfo = document.getElementById('pageInfo');
        
        document.addEventListener('DOMContentLoaded', async () => {
            checkApiHealth(); loadStats(); loadCategories();
            loadPostsBtn.addEventListener('click', loadPosts);
            categoryFilter.addEventListener('change', (e) => { currentCategory = e.target.value; currentCategoryElement.textContent = currentCategory || 'All'; currentPage = 1; });
            mediaTypeFilter.addEventListener('change', (e) => { currentMediaType = e.target.value; currentPage = 1; });
            sortBy.addEventListener('change', (e) => { currentSort = e.target.value; currentPage = 1; renderPosts(); });
            prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPosts(); } });
            nextPageBtn.addEventListener('click', () => { const totalPages = Math.ceil(allPosts.length / postsPerPage); if (currentPage < totalPages) { currentPage++; renderPosts(); } });
            setTimeout(() => { if (allPosts.length === 0) loadPosts(); }, 1000);
        });
        
        async function checkApiHealth() { try { const response = await fetch(`${API_BASE_URL}/health`); const data = await response.json(); if (data.status === 'healthy') { statusDot.classList.add('connected'); statusText.textContent = 'API Connected'; apiStatus.style.backgroundColor = '#e8f5e9'; } else { statusText.textContent = 'API Issues'; apiStatus.style.backgroundColor = '#ffebee'; } } catch (error) { statusText.textContent = 'API Unreachable'; apiStatus.style.backgroundColor = '#ffebee'; } }
        async function loadStats() { try { const response = await fetch(`${API_BASE_URL}/stats`); const data = await response.json(); if (data.success) { totalPosts = data.data.total_posts; totalPostsElement.textContent = totalPosts.toLocaleString(); } } catch (error) { console.error('Failed to load stats:', error); } }
        async function loadCategories() { try { const response = await fetch(`${API_BASE_URL}/categories`); const data = await response.json(); if (data.success) { while (categoryFilter.options.length > 1) categoryFilter.remove(1); data.data.forEach(category => { const option = document.createElement('option'); option.value = category.name; option.textContent = `${category.name} (${category.count})`; categoryFilter.appendChild(option); }); } } catch (error) { console.error('Failed to load categories:', error); } }
        async function loadPosts() { try { loadPostsBtn.disabled = true; loadPostsBtn.classList.add('loading-btn'); loadPostsBtn.querySelector('.btn-text').textContent = 'Loading...'; loadPostsBtn.querySelector('.spinner').style.display = 'inline-block';
            let url = `${API_BASE_URL}/posts`; const params = new URLSearchParams(); if (currentCategory) params.append('category', currentCategory); params.append('limit', 1000); if (params.toString()) url += `?${params.toString()}`;
            const response = await fetch(url); const data = await response.json(); if (data.success) { allPosts = data.data; displayedPostsElement.textContent = allPosts.length; processAndRenderPosts(); if (allPosts.length > 0) { noPostsMessage.style.display = 'none'; pagination.style.display = 'flex'; } else { noPostsMessage.style.display = 'block'; pagination.style.display = 'none'; } } else { showError('Failed to load posts: ' + (data.error || 'Unknown error')); } } catch (error) { console.error('Error loading posts:', error); showError('Failed to connect to server. Make sure Flask is running.'); } finally { loadPostsBtn.disabled = false; loadPostsBtn.classList.remove('loading-btn'); loadPostsBtn.querySelector('.btn-text').textContent = 'üì• Load Posts'; loadPostsBtn.querySelector('.spinner').style.display = 'none'; } }
        function processAndRenderPosts() { let filteredPosts = [...allPosts]; if (currentMediaType) filteredPosts = filteredPosts.filter(post => post.media_type === currentMediaType); filteredPosts.sort((a, b) => { const dateA = new Date(a.timestamp), dateB = new Date(b.timestamp); return currentSort === 'newest' ? dateB - dateA : dateA - dateB; }); allPosts = filteredPosts; renderPosts(); }
        function renderPosts() { postsContainer.innerHTML = ''; if (allPosts.length === 0) { noPostsMessage.style.display = 'block'; pagination.style.display = 'none'; displayedPostsElement.textContent = '0'; return; }
            const startIndex = (currentPage - 1) * postsPerPage, endIndex = startIndex + postsPerPage, pagePosts = allPosts.slice(startIndex, endIndex);
            const totalPages = Math.ceil(allPosts.length / postsPerPage); pageInfo.textContent = `Page ${currentPage} of ${totalPages}`; prevPageBtn.disabled = currentPage === 1; nextPageBtn.disabled = currentPage === totalPages;
            pagePosts.forEach(post => { const postElement = createPostElement(post); postsContainer.appendChild(postElement); }); displayedPostsElement.textContent = allPosts.length; }
        function createPostElement(post) { const div = document.createElement('div'); div.className = 'post-card'; const date = new Date(post.timestamp); const formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const mediaIcons = { text: 'üìù', photo: 'üñºÔ∏è', video: 'üé¨', document: 'üìÑ', audio: 'üéµ', sticker: 'ü§°' }; const mediaIcon = mediaIcons[post.media_type] || 'üìã'; const categoryClass = `category-${post.category || 'general'}`; const maxLength = 200; let contentPreview = post.content || 'No content'; let isTruncated = contentPreview.length > maxLength; if (isTruncated) contentPreview = contentPreview.substring(0, maxLength) + '...';
            div.innerHTML = `<div class="post-header"><span class="post-id">ID: ${post.message_id}</span><span class="post-category ${categoryClass}">${post.category || 'general'}</span></div>
                <div class="post-content">${escapeHtml(contentPreview)}${isTruncated ? '<div class="read-more"><button class="read-more-btn" onclick="toggleReadMore(this)">Read More</button></div>' : ''}</div>
                <div class="post-footer"><span class="post-media">${mediaIcon} ${post.media_type || 'text'}</span><span class="post-timestamp">üìÖ ${formattedDate}</span></div>`;
            if (isTruncated) div.querySelector('.post-content').dataset.fullContent = post.content; return div; }
        window.toggleReadMore = function(button) { const contentDiv = button.closest('.post-content'); const readMoreDiv = button.closest('.read-more'); if (contentDiv.classList.contains('expanded')) { contentDiv.classList.remove('expanded'); button.textContent = 'Read More'; readMoreDiv.style.display = 'flex'; } else { contentDiv.classList.add('expanded'); contentDiv.innerHTML = escapeHtml(contentDiv.dataset.fullContent) + '<div class="read-more"><button class="read-more-btn" onclick="toggleReadMore(this)">Read Less</button></div>'; } }
        function showError(message) { postsContainer.innerHTML = `<div class="no-posts"><div style="font-size:3rem;margin-bottom:10px;">‚ö†Ô∏è</div><h3>Error Loading Posts</h3><p>${message}</p><button onclick="loadPosts()" style="margin-top:15px;padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:8px;cursor:pointer;">Retry</button></div>`; noPostsMessage.style.display = 'none'; pagination.style.display = 'none'; }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) { const tg = window.Telegram.WebApp; tg.expand(); document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#0088cc'); document.documentElement.style.setProperty('--primary-dark', tg.themeParams.button_color || '#006699'); if (tg.initDataUnsafe.user) { const user = tg.initDataUnsafe.user; document.querySelector('.header p').textContent = `Hello, ${user.first_name}! Viewing saved channel posts`; } window.sendDataToBot = function(data) { tg.sendData(JSON.stringify(data)); }; }
    </script>
</body>
</html>
